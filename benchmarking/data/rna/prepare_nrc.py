import os
import subprocess
import shutil
import glob
    
# extracted from https://github.com/IcarPA-TBlab/nrc/blob/master/data/ECCB2017/dataset_Rfam_6320_13classes.fasta
families = {
'RF00001': '5S_rRNA',
'RF00002': '5_8S_rRNA',
'RF00005': 'tRNA',
'RF00008': 'ribozyme',
'RF00009': 'ribozyme',
'RF00010': 'ribozyme',
'RF00011': 'ribozyme',
'RF00012': 'CD-box',
'RF00016': 'CD-box',
'RF00027': 'miRNA',
'RF00028': 'Intron_gpI',
'RF00029': 'Intron_gpII',
'RF00030': 'ribozyme',
'RF00045': 'HACA-box',
'RF00047': 'miRNA',
'RF00049': 'CD-box',
'RF00050': 'riboswitch',
'RF00051': 'miRNA',
'RF00052': 'miRNA',
'RF00053': 'miRNA',
'RF00055': 'CD-box',
'RF00056': 'HACA-box',
'RF00059': 'riboswitch',
'RF00061': 'IRES',
'RF00065': 'CD-box',
'RF00067': 'CD-box',
'RF00068': 'CD-box',
'RF00069': 'CD-box',
'RF00071': 'CD-box',
'RF00075': 'miRNA',
'RF00085': 'CD-box',
'RF00087': 'CD-box',
'RF00089': 'CD-box',
'RF00090': 'HACA-box',
'RF00091': 'HACA-box',
'RF00093': 'CD-box',
'RF00095': 'CD-box',
'RF00096': 'CD-box',
'RF00097': 'CD-box',
'RF00099': 'CD-box',
'RF00103': 'miRNA',
'RF00104': 'miRNA',
'RF00105': 'CD-box',
'RF00108': 'CD-box',
'RF00114': 'leader',
'RF00131': 'miRNA',
'RF00132': 'CD-box',
'RF00133': 'CD-box',
'RF00135': 'CD-box',
'RF00136': 'CD-box',
'RF00137': 'CD-box',
'RF00138': 'CD-box',
'RF00139': 'HACA-box',
'RF00145': 'CD-box',
'RF00147': 'CD-box',
'RF00149': 'CD-box',
'RF00150': 'CD-box',
'RF00151': 'CD-box',
'RF00152': 'CD-box',
'RF00153': 'CD-box',
'RF00154': 'CD-box',
'RF00155': 'HACA-box',
'RF00156': 'HACA-box',
'RF00157': 'CD-box',
'RF00158': 'CD-box',
'RF00160': 'CD-box',
'RF00162': 'riboswitch',
'RF00163': 'ribozyme',
'RF00167': 'riboswitch',
'RF00168': 'riboswitch',
'RF00174': 'riboswitch',
'RF00181': 'CD-box',
'RF00188': 'CD-box',
'RF00190': 'HACA-box',
'RF00191': 'HACA-box',
'RF00200': 'CD-box',
'RF00201': 'CD-box',
'RF00203': 'CD-box',
'RF00205': 'CD-box',
'RF00206': 'CD-box',
'RF00208': 'CD-box',
'RF00209': 'IRES',
'RF00210': 'IRES',
'RF00212': 'CD-box',
'RF00213': 'CD-box',
'RF00216': 'IRES',
'RF00218': 'CD-box',
'RF00221': 'CD-box',
'RF00222': 'IRES',
'RF00223': 'IRES',
'RF00224': 'IRES',
'RF00225': 'IRES',
'RF00226': 'IRES',
'RF00228': 'IRES',
'RF00229': 'IRES',
'RF00231': 'scaRNA',
'RF00234': 'riboswitch',
'RF00237': 'miRNA',
'RF00239': 'miRNA',
'RF00241': 'miRNA',
'RF00246': 'miRNA',
'RF00247': 'miRNA',
'RF00248': 'miRNA',
'RF00249': 'miRNA',
'RF00250': 'miRNA',
'RF00254': 'miRNA',
'RF00257': 'miRNA',
'RF00261': 'IRES',
'RF00263': 'HACA-box',
'RF00264': 'HACA-box',
'RF00265': 'HACA-box',
'RF00266': 'CD-box',
'RF00270': 'CD-box',
'RF00271': 'CD-box',
'RF00272': 'HACA-box',
'RF00273': 'CD-box',
'RF00274': 'CD-box',
'RF00275': 'CD-box',
'RF00277': 'CD-box',
'RF00278': 'CD-box',
'RF00279': 'CD-box',
'RF00280': 'CD-box',
'RF00283': 'scaRNA',
'RF00284': 'CD-box',
'RF00286': 'scaRNA',
'RF00287': 'CD-box',
'RF00289': 'CD-box',
'RF00296': 'CD-box',
'RF00300': 'CD-box',
'RF00302': 'HACA-box',
'RF00303': 'HACA-box',
'RF00309': 'CD-box',
'RF00315': 'CD-box',
'RF00319': 'HACA-box',
'RF00321': 'CD-box',
'RF00322': 'HACA-box',
'RF00324': 'CD-box',
'RF00325': 'CD-box',
'RF00326': 'CD-box',
'RF00329': 'CD-box',
'RF00330': 'CD-box',
'RF00332': 'CD-box',
'RF00334': 'HACA-box',
'RF00335': 'CD-box',
'RF00337': 'CD-box',
'RF00339': 'CD-box',
'RF00340': 'HACA-box',
'RF00341': 'CD-box',
'RF00342': 'CD-box',
'RF00343': 'CD-box',
'RF00345': 'CD-box',
'RF00350': 'CD-box',
'RF00352': 'CD-box',
'RF00353': 'CD-box',
'RF00355': 'CD-box',
'RF00357': 'CD-box',
'RF00359': 'CD-box',
'RF00360': 'CD-box',
'RF00373': 'ribozyme',
'RF00377': 'CD-box',
'RF00387': 'IRES',
'RF00392': 'HACA-box',
'RF00393': 'HACA-box',
'RF00394': 'HACA-box',
'RF00396': 'HACA-box',
'RF00397': 'HACA-box',
'RF00398': 'HACA-box',
'RF00399': 'HACA-box',
'RF00400': 'HACA-box',
'RF00401': 'HACA-box',
'RF00402': 'HACA-box',
'RF00403': 'HACA-box',
'RF00404': 'HACA-box',
'RF00405': 'HACA-box',
'RF00406': 'HACA-box',
'RF00408': 'HACA-box',
'RF00409': 'HACA-box',
'RF00410': 'HACA-box',
'RF00411': 'HACA-box',
'RF00412': 'HACA-box',
'RF00413': 'HACA-box',
'RF00414': 'HACA-box',
'RF00417': 'HACA-box',
'RF00418': 'HACA-box',
'RF00420': 'HACA-box',
'RF00421': 'HACA-box',
'RF00422': 'scaRNA',
'RF00423': 'scaRNA',
'RF00424': 'scaRNA',
'RF00425': 'HACA-box',
'RF00426': 'scaRNA',
'RF00427': 'scaRNA',
'RF00428': 'HACA-box',
'RF00429': 'HACA-box',
'RF00430': 'HACA-box',
'RF00431': 'HACA-box',
'RF00432': 'HACA-box',
'RF00438': 'HACA-box',
'RF00439': 'CD-box',
'RF00440': 'CD-box',
'RF00443': 'HACA-box',
'RF00445': 'miRNA',
'RF00446': 'miRNA',
'RF00447': 'IRES',
'RF00448': 'IRES',
'RF00449': 'IRES',
'RF00451': 'miRNA',
'RF00452': 'miRNA',
'RF00455': 'miRNA',
'RF00457': 'IRES',
'RF00458': 'IRES',
'RF00461': 'IRES',
'RF00462': 'IRES',
'RF00464': 'miRNA',
'RF00471': 'CD-box',
'RF00472': 'CD-box',
'RF00473': 'CD-box',
'RF00474': 'CD-box',
'RF00476': 'CD-box',
'RF00478': 'scaRNA',
'RF00483': 'IRES',
'RF00484': 'IRES',
'RF00487': 'IRES',
'RF00492': 'scaRNA',
'RF00494': 'CD-box',
'RF00495': 'IRES',
'RF00504': 'riboswitch',
'RF00506': 'leader',
'RF00511': 'IRES',
'RF00512': 'leader',
'RF00513': 'leader',
'RF00514': 'leader',
'RF00521': 'riboswitch',
'RF00522': 'riboswitch',
'RF00530': 'CD-box',
'RF00532': 'CD-box',
'RF00533': 'CD-box',
'RF00541': 'HACA-box',
'RF00543': 'HACA-box',
'RF00545': 'HACA-box',
'RF00546': 'HACA-box',
'RF00547': 'IRES',
'RF00549': 'IRES',
'RF00553': 'scaRNA',
'RF00554': 'HACA-box',
'RF00555': 'leader',
'RF00556': 'leader',
'RF00557': 'leader',
'RF00558': 'leader',
'RF00559': 'leader',
'RF00560': 'HACA-box',
'RF00561': 'HACA-box',
'RF00562': 'HACA-box',
'RF00563': 'HACA-box',
'RF00564': 'scaRNA',
'RF00565': 'scaRNA',
'RF00566': 'HACA-box',
'RF00568': 'HACA-box',
'RF00569': 'CD-box',
'RF00570': 'CD-box',
'RF00572': 'CD-box',
'RF00573': 'CD-box',
'RF00575': 'CD-box',
'RF00576': 'HACA-box',
'RF00577': 'CD-box',
'RF00578': 'CD-box',
'RF00579': 'CD-box',
'RF00581': 'CD-box',
'RF00582': 'scaRNA',
'RF00588': 'CD-box',
'RF00593': 'CD-box',
'RF00594': 'CD-box',
'RF00598': 'HACA-box',
'RF00599': 'HACA-box',
'RF00601': 'scaRNA',
'RF00602': 'scaRNA',
'RF00604': 'CD-box',
'RF00611': 'CD-box',
'RF00613': 'CD-box',
'RF00614': 'HACA-box',
'RF00622': 'ribozyme',
'RF00634': 'riboswitch',
'RF00637': 'miRNA',
'RF00638': 'miRNA',
'RF00639': 'miRNA',
'RF00640': 'miRNA',
'RF00641': 'miRNA',
'RF00642': 'miRNA',
'RF00643': 'miRNA',
'RF00644': 'miRNA',
'RF00645': 'miRNA',
'RF00646': 'miRNA',
'RF00647': 'miRNA',
'RF00648': 'miRNA',
'RF00652': 'miRNA',
'RF00653': 'miRNA',
'RF00654': 'miRNA',
'RF00655': 'miRNA',
'RF00659': 'miRNA',
'RF00661': 'miRNA',
'RF00662': 'miRNA',
'RF00663': 'miRNA',
'RF00665': 'miRNA',
'RF00668': 'miRNA',
'RF00669': 'miRNA',
'RF00670': 'miRNA',
'RF00672': 'miRNA',
'RF00677': 'miRNA',
'RF00679': 'miRNA',
'RF00680': 'miRNA',
'RF00682': 'miRNA',
'RF00684': 'miRNA',
'RF00685': 'miRNA',
'RF00688': 'miRNA',
'RF00689': 'miRNA',
'RF00690': 'miRNA',
'RF00692': 'miRNA',
'RF00693': 'miRNA',
'RF00694': 'miRNA',
'RF00695': 'miRNA',
'RF00697': 'miRNA',
'RF00698': 'miRNA',
'RF00702': 'miRNA',
'RF00704': 'miRNA',
'RF00706': 'miRNA',
'RF00708': 'miRNA',
'RF00711': 'miRNA',
'RF00713': 'miRNA',
'RF00714': 'miRNA',
'RF00716': 'miRNA',
'RF00720': 'miRNA',
'RF00722': 'miRNA',
'RF00723': 'miRNA',
'RF00724': 'miRNA',
'RF00727': 'miRNA',
'RF00731': 'miRNA',
'RF00732': 'miRNA',
'RF00734': 'miRNA',
'RF00736': 'miRNA',
'RF00746': 'miRNA',
'RF00749': 'miRNA',
'RF00751': 'miRNA',
'RF00753': 'miRNA',
'RF00754': 'miRNA',
'RF00757': 'miRNA',
'RF00761': 'miRNA',
'RF00764': 'miRNA',
'RF00765': 'miRNA',
'RF00767': 'miRNA',
'RF00768': 'miRNA',
'RF00772': 'miRNA',
'RF00775': 'miRNA',
'RF00778': 'miRNA',
'RF00779': 'miRNA',
'RF00782': 'miRNA',
'RF00786': 'miRNA',
'RF00789': 'miRNA',
'RF00791': 'miRNA',
'RF00794': 'miRNA',
'RF00797': 'miRNA',
'RF00800': 'miRNA',
'RF00816': 'miRNA',
'RF00818': 'miRNA',
'RF00821': 'miRNA',
'RF00824': 'miRNA',
'RF00832': 'miRNA',
'RF00833': 'miRNA',
'RF00835': 'miRNA',
'RF00840': 'miRNA',
'RF00841': 'miRNA',
'RF00842': 'miRNA',
'RF00845': 'miRNA',
'RF00846': 'miRNA',
'RF00851': 'miRNA',
'RF00855': 'miRNA',
'RF00857': 'miRNA',
'RF00858': 'miRNA',
'RF00863': 'miRNA',
'RF00865': 'miRNA',
'RF00875': 'miRNA',
'RF00876': 'miRNA',
'RF00882': 'miRNA',
'RF00885': 'miRNA',
'RF00887': 'miRNA',
'RF00892': 'miRNA',
'RF00893': 'miRNA',
'RF00899': 'miRNA',
'RF00900': 'miRNA',
'RF00903': 'miRNA',
'RF00904': 'miRNA',
'RF00906': 'miRNA',
'RF00908': 'miRNA',
'RF00909': 'miRNA',
'RF00912': 'miRNA',
'RF00918': 'miRNA',
'RF00920': 'miRNA',
'RF00928': 'miRNA',
'RF00931': 'miRNA',
'RF00937': 'miRNA',
'RF00940': 'miRNA',
'RF00943': 'miRNA',
'RF00950': 'miRNA',
'RF00951': 'miRNA',
'RF00952': 'miRNA',
'RF00960': 'miRNA',
'RF00972': 'miRNA',
'RF00973': 'miRNA',
'RF00986': 'miRNA',
'RF00989': 'miRNA',
'RF00994': 'miRNA',
'RF00995': 'miRNA',
'RF00998': 'miRNA',
'RF01010': 'miRNA',
'RF01012': 'miRNA',
'RF01016': 'miRNA',
'RF01018': 'miRNA',
'RF01022': 'miRNA',
'RF01026': 'miRNA',
'RF01040': 'miRNA',
'RF01042': 'miRNA',
'RF01043': 'miRNA',
'RF01045': 'miRNA',
'RF01055': 'riboswitch',
'RF01056': 'riboswitch',
'RF01057': 'riboswitch',
'RF01059': 'miRNA',
'RF01061': 'miRNA',
'RF01127': 'CD-box',
'RF01131': 'CD-box',
'RF01133': 'CD-box',
'RF01137': 'CD-box',
'RF01139': 'CD-box',
'RF01140': 'CD-box',
'RF01144': 'CD-box',
'RF01158': 'CD-box',
'RF01166': 'CD-box',
'RF01168': 'CD-box',
'RF01169': 'CD-box',
'RF01171': 'CD-box',
'RF01173': 'CD-box',
'RF01176': 'CD-box',
'RF01178': 'CD-box',
'RF01179': 'CD-box',
'RF01183': 'CD-box',
'RF01185': 'CD-box',
'RF01191': 'CD-box',
'RF01198': 'CD-box',
'RF01199': 'CD-box',
'RF01201': 'CD-box',
'RF01206': 'HACA-box',
'RF01208': 'HACA-box',
'RF01209': 'CD-box',
'RF01210': 'CD-box',
'RF01212': 'CD-box',
'RF01213': 'HACA-box',
'RF01214': 'CD-box',
'RF01215': 'HACA-box',
'RF01218': 'CD-box',
'RF01219': 'HACA-box',
'RF01220': 'HACA-box',
'RF01223': 'CD-box',
'RF01224': 'HACA-box',
'RF01225': 'HACA-box',
'RF01227': 'HACA-box',
'RF01228': 'HACA-box',
'RF01230': 'HACA-box',
'RF01231': 'HACA-box',
'RF01233': 'HACA-box',
'RF01234': 'HACA-box',
'RF01237': 'HACA-box',
'RF01239': 'HACA-box',
'RF01240': 'HACA-box',
'RF01241': 'HACA-box',
'RF01242': 'HACA-box',
'RF01247': 'HACA-box',
'RF01248': 'HACA-box',
'RF01249': 'CD-box',
'RF01251': 'HACA-box',
'RF01252': 'HACA-box',
'RF01253': 'HACA-box',
'RF01254': 'HACA-box',
'RF01255': 'HACA-box',
'RF01256': 'HACA-box',
'RF01257': 'HACA-box',
'RF01258': 'HACA-box',
'RF01259': 'CD-box',
'RF01261': 'HACA-box',
'RF01262': 'HACA-box',
'RF01263': 'HACA-box',
'RF01264': 'HACA-box',
'RF01266': 'CD-box',
'RF01268': 'scaRNA',
'RF01269': 'HACA-box',
'RF01274': 'CD-box',
'RF01277': 'CD-box',
'RF01278': 'CD-box',
'RF01279': 'CD-box',
'RF01284': 'CD-box',
'RF01285': 'CD-box',
'RF01287': 'CD-box',
'RF01288': 'CD-box',
'RF01290': 'CD-box',
'RF01292': 'HACA-box',
'RF01294': 'HACA-box',
'RF01295': 'scaRNA',
'RF01296': 'HACA-box',
'RF01299': 'CD-box',
'RF01300': 'CD-box',
'RF01302': 'CD-box',
'RF01413': 'miRNA',
'RF01421': 'CD-box',
'RF01422': 'CD-box',
'RF01426': 'CD-box',
'RF01428': 'CD-box',
'RF01429': 'CD-box',
'RF01430': 'HACA-box',
'RF01431': 'HACA-box',
'RF01432': 'HACA-box',
'RF01433': 'HACA-box',
'RF01436': 'HACA-box',
'RF01438': 'HACA-box',
'RF01448': 'HACA-box',
'RF01482': 'riboswitch',
'RF01505': 'CD-box',
'RF01506': 'CD-box',
'RF01509': 'CD-box',
'RF01511': 'CD-box',
'RF01515': 'CD-box',
'RF01524': 'HACA-box',
'RF01525': 'HACA-box',
'RF01535': 'HACA-box',
'RF01536': 'HACA-box',
'RF01552': 'HACA-box',
'RF01573': 'CD-box',
'RF01577': 'ribozyme',
'RF01588': 'CD-box',
'RF01602': 'HACA-box',
'RF01606': 'HACA-box',
'RF01609': 'CD-box',
'RF01612': 'HACA-box',
'RF01614': 'HACA-box',
'RF01617': 'CD-box',
'RF01620': 'HACA-box',
'RF01629': 'HACA-box',
'RF01630': 'CD-box',
'RF01644': 'HACA-box',
'RF01649': 'HACA-box',
'RF01660': 'HACA-box',
'RF01661': 'HACA-box',
'RF01662': 'CD-box',
'RF01664': 'HACA-box',
'RF01689': 'riboswitch',
'RF01725': 'riboswitch',
'RF01727': 'riboswitch',
'RF01786': 'riboswitch',
'RF01787': 'riboswitch',
'RF01788': 'riboswitch',
'RF01807': 'ribozyme',
'RF01831': 'riboswitch',
'RF01846': 'CD-box',
'RF01847': 'CD-box',
'RF01848': 'CD-box',
'RF01859': 'leader',
'RF01860': 'CD-box',
'RF01865': 'ribozyme',
'RF01899': 'miRNA',
'RF01903': 'miRNA',
'RF01911': 'miRNA',
'RF01914': 'miRNA',
'RF01917': 'miRNA',
'RF01922': 'miRNA',
'RF01926': 'miRNA',
'RF01942': 'miRNA',
'RF01943': 'miRNA',
'RF01997': 'miRNA',
'RF02000': 'miRNA',
'RF02026': 'miRNA',
'RF02027': 'miRNA',
'RF02094': 'miRNA',
'RF02096': 'miRNA',
'RF02244': 'miRNA',
'RF02254': 'miRNA',
'RF02275': 'ribozyme',
'RF02276': 'ribozyme',
'RF02285': 'CD-box',
'RF02288': 'CD-box',
'RF02289': 'CD-box',
'RF02315': 'HACA-box',
'RF02357': 'ribozyme',
'RF02370': 'leader',
'RF02371': 'leader',
'RF02373': 'leader',
'RF02402': 'CD-box',
'RF02407': 'CD-box',
'RF02410': 'HACA-box',
'RF02411': 'HACA-box',
'RF02487': 'HACA-box',
'RF02490': 'HACA-box',
'RF02516': 'miRNA',
'RF02518': 'miRNA',
'RF02530': 'IRES',
'RF02531': 'IRES',
'RF02535': 'IRES',
}


classes = set(families.values())

for c in classes:
    os.makedirs(c, exist_ok=True)


#download all files.
for fam, cls in families.items():
    #wget http://ftp.ebi.ac.uk/pub/databases/Rfam/14.6/fasta_files/RF00001.fa.gz
    url = f'http://ftp.ebi.ac.uk/pub/databases/Rfam/14.6/fasta_files/{fam}.fa.gz'
    subprocess.run(['wget', url, '-P', cls])


os.makedirs('temp_dir', exist_ok=True)
for cls in classes:
    # original command
    #zcat 5S_rRNA/* | sed -E 's/(>[^\s\\ ]*).*/\1|label=rna/' 

    # make one file per family
    files = glob.glob(f'{cls}/*')
    with open(f'{cls}/temp.fasta', 'w') as f:
        subprocess.run(['zcat'] + files, stdout=f)

    # shorten headers and add class label
    with open(f'temp_dir/{cls}.fasta', 'w') as f:
        subprocess.run([
                    'sed', '-E', f's/(>[^\s\\ ]*).*/\\1|label={cls}/',
                    f'{cls}/temp.fasta',
                    ],
                    stdout=f,
                )

for c in classes:
    shutil.rmtree(c, ignore_errors=True)

# Finally, to create a balanced dataset, 
# we randomly selected 500 sequences for each ncRNA class, except IRES for 
# which there are only 320 available sequences, to obtain 6320 ncRNA sequences.
import random

files = glob.glob('temp_dir/*')
with open('nRC_all.fasta', 'w') as f:
    for file in files:
        with open(file, 'r') as f2:
            lines = f2.readlines()
            headers, seqs = lines[0::2], lines[1::2]

            # pick max 500.
            if len(headers)<=500:
                for h, s in zip(headers, seqs):
                    f.write(h)
                    f.write(s)

            else:
                inds = random.sample(range(0, len(headers)), 500)
                for i in inds:
                    f.write(headers[i])
                    f.write(seqs[i])


            
        


    #subprocess.run(['cat'] + files, stdout = f)


shutil.rmtree('temp_dir', ignore_errors=True)